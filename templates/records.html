<!DOCTYPE html>
<html lang="zh">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>è¿è¡Œè®°å½• - Pythoné¡¹ç›®ç®¡ç†ç³»ç»Ÿ</title>
    <link rel="stylesheet" href="/static/css/style.css">
</head>
<body>
    <nav class="main-nav">
        <div class="nav-logo">Pythoné¡¹ç›®ç®¡ç†ç³»ç»Ÿ</div>
        <ul class="nav-links">
            <li><a href="/projects">é¡¹ç›®ç®¡ç†</a></li>
            <li><a href="/runner">é¡¹ç›®è¿è¡Œ</a></li>
            <li><a href="/records" class="active">è¿è¡Œè®°å½•</a></li>
            <li><a href="/scheduler">ä»»åŠ¡é…ç½®</a></li>
        </ul>
    </nav>
    <div class="main-content">
        <h1>è¿è¡Œè®°å½•</h1>
        <div class="records-container">
            <div class="records-list" id="recordsList">
                <!-- è®°å½•å°†é€šè¿‡JavaScriptåŠ¨æ€ç”Ÿæˆ -->
            </div>
        </div>
    </div>

    <script>
        const recordsList = document.getElementById('recordsList');

        // æ ¼å¼åŒ–æ—¶é—´
        function formatDate(dateStr) {
            const date = new Date(dateStr);
            return date.toLocaleString('zh-CN', {
                year: 'numeric',
                month: '2-digit',
                day: '2-digit',
                hour: '2-digit',
                minute: '2-digit',
                second: '2-digit'
            });
        }

        // æ ¼å¼åŒ–æŒç»­æ—¶é—´
        function formatDuration(seconds) {
            if (!seconds) return 'æœªçŸ¥';
            if (seconds < 1) {
                return `${(seconds * 1000).toFixed(0)}ms`;
            }
            return `${seconds.toFixed(2)}s`;
        }

        // åˆ é™¤è®°å½•
        async function deleteRecord(recordId) {
            if (!confirm('ç¡®å®šè¦åˆ é™¤è¿™æ¡è¿è¡Œè®°å½•å—ï¼Ÿ')) {
                return;
            }

            try {
                const response = await fetch(`/api/records/${recordId}`, {
                    method: 'DELETE'
                });

                if (response.ok) {
                    // é‡æ–°åŠ è½½è®°å½•åˆ—è¡¨
                    loadRecords();
                } else {
                    const data = await response.json();
                    alert(data.error || 'åˆ é™¤å¤±è´¥');
                }
            } catch (error) {
                alert('åˆ é™¤å¤±è´¥: ' + error.message);
            }
        }

        // åŠ è½½è¿è¡Œè®°å½•
        async function loadRecords() {
            try {
                const response = await fetch('/api/records');
                const result = await response.json();
                
                if (result.records.length === 0) {
                    recordsList.innerHTML = `
                        <div class="no-records">
                            æš‚æ— è¿è¡Œè®°å½•
                        </div>
                    `;
                    return;
                }

                recordsList.innerHTML = result.records.map(record => `
                    <div class="record-card ${record.status}">
                        <div class="record-header">
                            <div class="record-title">
                                <span class="project-title">${record.project_title}</span>
                                ${record.running_status === 'running' ? 
                                    '<span class="running-badge">è¿è¡Œä¸­</span>' :
                                    `<span class="status-badge ${record.status}">
                                        ${record.status === 'success' ? 'æˆåŠŸ' : 'å¤±è´¥'}
                                    </span>`
                                }
                            </div>
                            <div class="record-actions">
                                <button onclick="rerunRecord(${record.id})" class="btn rerun-btn" title="ä½¿ç”¨ç›¸åŒé…ç½®å†æ¬¡è¿è¡Œ">
                                    <span class="btn-icon">ğŸ”„</span>å†æ¬¡æ‰§è¡Œ
                                </button>
                                ${record.output_file ? `
                                    <a href="/api/records/${record.output_file}/download" 
                                       class="btn download-btn">ä¸‹è½½äº§ç‰©</a>
                                    <a href="/downloads/${record.output_file}/output" 
                                       class="btn download-btn" target="_blank">æŸ¥çœ‹è¾“å‡º</a>
                                ` : ''}
                                ${record.running_status === 'running' ? `
                                    <button onclick="terminateRecord(${record.id})" class="btn terminate-btn">ç»ˆæ­¢</button>
                                ` : ''}
                                <button onclick="deleteRecord(${record.id})" class="btn delete-btn">åˆ é™¤</button>
                            </div>
                        </div>
                        <div class="record-content">
                            <div class="command-section">
                                <span class="command-label">å‘½ä»¤ï¼š</span>
                                <code>${record.command}</code>
                            </div>
                            <div class="record-details">
                                <div class="record-info">
                                    <div class="info-item">
                                        <span class="info-label">è¿è¡Œæ—¶é—´ï¼š</span>
                                        <span>${formatDate(record.created_at)}</span>
                                    </div>
                                    <div class="info-item">
                                        <span class="info-label">è€—æ—¶ï¼š</span>
                                        <span>${formatDuration(record.duration)}</span>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                `).join('');
            } catch (error) {
                recordsList.innerHTML = `
                    <div class="error-message">
                        åŠ è½½è®°å½•å¤±è´¥: ${error.message}
                    </div>
                `;
            }
        }

        // åˆå§‹åŠ è½½
        loadRecords();

        // æ¯30ç§’åˆ·æ–°ä¸€æ¬¡
        setInterval(loadRecords, 30000);

        async function terminateRecord(recordId) {
            if (!confirm('ç¡®å®šè¦ç»ˆæ­¢è¿™ä¸ªä»»åŠ¡å—ï¼Ÿ')) {
                return;
            }

            try {
                const response = await fetch(`/api/records/${recordId}/terminate`, {
                    method: 'POST'
                });

                if (response.ok) {
                    alert('ä»»åŠ¡å·²ç»ˆæ­¢');
                    loadRecords();  // Reload the records list
                } else {
                    const data = await response.json();
                    alert(data.error || 'ç»ˆæ­¢å¤±è´¥');
                }
            } catch (error) {
                alert('ç»ˆæ­¢å¤±è´¥: ' + error.message);
            }
        }

        // ä¿®æ”¹å†æ¬¡æ‰§è¡Œå‡½æ•°
        async function rerunRecord(recordId) {
            try {
                // è·å–è®°å½•è¯¦æƒ…
                const response = await fetch(`/api/records/${recordId}`);
                if (!response.ok) {
                    throw new Error('è·å–è®°å½•è¯¦æƒ…å¤±è´¥');
                }
                const record = await response.json();

                // å¤„ç†å‘½ä»¤ï¼Œç§»é™¤è¾“å‡ºç›®å½•å’Œæ—¥å¿—ç›®å½•å‚æ•°
                let command = record.command;
                command = command.replace(/\s+--output_dir\s+\S+/g, '');
                command = command.replace(/\s+--log_dir\s+\S+/g, '');
                command = command.trim();

                // å°†è®°å½•ä¿¡æ¯å­˜å‚¨åˆ° sessionStorage
                sessionStorage.setItem('rerunConfig', JSON.stringify({
                    projectId: record.project_id,
                    command: command
                }));

                // è·³è½¬åˆ°è¿è¡Œç•Œé¢
                window.location.href = '/runner';
            } catch (error) {
                alert('è·å–è®°å½•ä¿¡æ¯å¤±è´¥: ' + error.message);
            }
        }
    </script>

    <style>
        .record-card {
            background: white;
            border-radius: 8px;
            padding: 1rem;
            margin-bottom: 1rem;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }

        .record-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1rem;
        }

        .record-title {
            display: flex;
            align-items: center;
            gap: 1rem;
        }

        .record-actions {
            display: flex;
            gap: 0.5rem;
        }

        .delete-btn {
            background-color: #dc3545;
        }

        .delete-btn:hover {
            background-color: #c82333;
        }

        .running-badge {
            background-color: #2196f3;
            color: white;
            padding: 0.25rem 0.5rem;
            border-radius: 4px;
            font-size: 0.9em;
            margin-left: 0.5rem;
            animation: pulse 1.5s infinite;
        }

        @keyframes pulse {
            0% { opacity: 1; }
            50% { opacity: 0.6; }
            100% { opacity: 1; }
        }

        .download-btn {
            background-color: #28a745;
        }
        
        .download-btn:hover {
            background-color: #218838;
        }

        .terminate-btn {
            background-color: #ff9800;
        }

        .terminate-btn:hover {
            background-color: #f57c00;
        }
    </style>
</body>
</html> 