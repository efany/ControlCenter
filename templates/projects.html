<!DOCTYPE html>
<html lang="zh">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>é¡¹ç›®ç®¡ç† - Pythoné¡¹ç›®ç®¡ç†ç³»ç»Ÿ</title>
    <link rel="stylesheet" href="/static/css/style.css">
</head>
<body>
    <nav class="main-nav">
        <div class="nav-logo">Pythoné¡¹ç›®ç®¡ç†ç³»ç»Ÿ</div>
        <ul class="nav-links">
            <li><a href="/projects" class="active">é¡¹ç›®ç®¡ç†</a></li>
            <li><a href="/runner">é¡¹ç›®è¿è¡Œ</a></li>
            <li><a href="/records">è¿è¡Œè®°å½•</a></li>
            <li><a href="/scheduler">ä»»åŠ¡é…ç½®</a></li>
        </ul>
    </nav>
    <div class="main-content">
        <h1>é¡¹ç›®ç®¡ç†</h1>
        <div class="create-project">
            <h2>åˆ›å»ºæ–°é¡¹ç›®</h2>
            <form id="projectForm" class="project-form">
                <div class="form-group">
                    <label for="projectTitle">é¡¹ç›®æ ‡é¢˜ï¼š</label>
                    <input type="text" id="projectTitle" required placeholder="è¾“å…¥é¡¹ç›®æ ‡é¢˜">
                </div>
                <div class="form-group">
                    <label for="projectDesc">é¡¹ç›®æè¿°ï¼š</label>
                    <textarea id="projectDesc" rows="3" placeholder="è¾“å…¥é¡¹ç›®æè¿°"></textarea>
                </div>
                <div class="form-group">
                    <label>é¡¹ç›®æ¥æºï¼š</label>
                    <div class="source-selector">
                        <label class="source-option">
                            <input type="radio" name="projectSource" value="files" checked>
                            <span>æ–‡ä»¶ä¸Šä¼ </span>
                        </label>
                        <label class="source-option">
                            <input type="radio" name="projectSource" value="git">
                            <span>Gitä»“åº“</span>
                        </label>
                    </div>
                </div>
                <div id="fileUploadSection" class="source-section">
                    <div class="upload-section">
                        <div class="upload-area" id="dropZone">
                            <div class="upload-icon">ğŸ“</div>
                            <div class="upload-text">æ‹–æ‹½æ–‡ä»¶åˆ°æ­¤å¤„æˆ–ç‚¹å‡»é€‰æ‹©æ–‡ä»¶</div>
                            <div class="file-types">æ”¯æŒçš„æ–‡ä»¶ç±»å‹: .py, .zip, .rar, .tar.gz, .7z</div>
                            <input type="file" id="fileInput" multiple accept=".py,.zip,.rar,.tar.gz,.7z">
                        </div>
                        <div class="selected-files" id="selectedFiles"></div>
                    </div>
                </div>
                <div id="gitSection" class="source-section" style="display: none;">
                    <div class="form-group">
                        <label for="gitUrl">Gitä»“åº“åœ°å€ï¼š</label>
                        <input type="url" id="gitUrl" placeholder="https://github.com/username/repo.git">
                    </div>
                    <div class="form-group">
                        <label for="gitBranch">åˆ†æ”¯ï¼š</label>
                        <input type="text" id="gitBranch" placeholder="main" value="main">
                    </div>
                </div>
                <div class="form-actions">
                    <button type="submit" id="createBtn" class="btn" disabled>åˆ›å»ºé¡¹ç›®</button>
                </div>
            </form>
            <div class="progress-bar">
                <div class="progress"></div>
            </div>
            <div class="status-message"></div>
        </div>
        <div class="projects-list">
            <h2>é¡¹ç›®åˆ—è¡¨</h2>
            <div class="list-container" id="projectsList"></div>
        </div>
    </div>

    <script>
        const projectForm = document.getElementById('projectForm');
        const projectTitle = document.getElementById('projectTitle');
        const projectDesc = document.getElementById('projectDesc');
        const dropZone = document.getElementById('dropZone');
        const fileInput = document.getElementById('fileInput');
        const createBtn = document.getElementById('createBtn');
        const selectedFiles = document.getElementById('selectedFiles');
        const progressBar = document.querySelector('.progress');
        const statusMessage = document.querySelector('.status-message');
        const projectsList = document.getElementById('projectsList');
        const projectSource = document.getElementsByName('projectSource');
        const fileUploadSection = document.getElementById('fileUploadSection');
        const gitSection = document.getElementById('gitSection');
        const gitUrl = document.getElementById('gitUrl');
        const gitBranch = document.getElementById('gitBranch');

        // ç”Ÿæˆ12ä½é¡¹ç›®ID
        function generateProjectId() {
            const chars = '0123456789abcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVWXYZ';
            let result = '';
            for (let i = 0; i < 12; i++) {
                result += chars[Math.floor(Math.random() * chars.length)];
            }
            return result;
        }

        // æ›´æ–°é€‰ä¸­æ–‡ä»¶æ˜¾ç¤º
        function updateSelectedFiles() {
            const files = fileInput.files;
            if (files.length > 0) {
                selectedFiles.innerHTML = Array.from(files).map(file => `
                    <div class="selected-file">
                        <span class="file-name">${file.name}</span>
                        <span class="file-size">(${formatFileSize(file.size)})</span>
                    </div>
                `).join('');
                createBtn.disabled = !projectTitle.value;
            } else {
                selectedFiles.innerHTML = '';
                createBtn.disabled = true;
            }
        }

        // æ ¼å¼åŒ–æ–‡ä»¶å¤§å°
        function formatFileSize(bytes) {
            if (bytes === 0) return '0 B';
            const k = 1024;
            const sizes = ['B', 'KB', 'MB', 'GB'];
            const i = Math.floor(Math.log(bytes) / Math.log(k));
            return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
        }

        // æ–‡ä»¶é€‰æ‹©å¤„ç†
        fileInput.addEventListener('change', updateSelectedFiles);
        projectTitle.addEventListener('input', () => {
            createBtn.disabled = !projectTitle.value || fileInput.files.length === 0;
        });

        // æ‹–æ”¾å¤„ç†
        ['dragenter', 'dragover', 'dragleave', 'drop'].forEach(eventName => {
            dropZone.addEventListener(eventName, preventDefaults, false);
        });

        function preventDefaults(e) {
            e.preventDefault();
            e.stopPropagation();
        }

        ['dragenter', 'dragover'].forEach(eventName => {
            dropZone.addEventListener(eventName, () => {
                dropZone.classList.add('drag-over');
            });
        });

        ['dragleave', 'drop'].forEach(eventName => {
            dropZone.addEventListener(eventName, () => {
                dropZone.classList.remove('drag-over');
            });
        });

        dropZone.addEventListener('drop', handleDrop);

        function handleDrop(e) {
            const dt = e.dataTransfer;
            const files = dt.files;
            fileInput.files = files;
            updateSelectedFiles();
        }

        // åˆ‡æ¢é¡¹ç›®æ¥æº
        projectSource.forEach(radio => {
            radio.addEventListener('change', () => {
                if (radio.value === 'files') {
                    fileUploadSection.style.display = 'block';
                    gitSection.style.display = 'none';
                    // æ–‡ä»¶ä¸Šä¼ æ¨¡å¼ä¸‹ï¼Œæ ¹æ®æ˜¯å¦æœ‰æ–‡ä»¶å’Œæ ‡é¢˜æ¥å†³å®šæŒ‰é’®ï¿½ï¿½ï¿½æ€
                    createBtn.disabled = !projectTitle.value || fileInput.files.length === 0;
                } else {
                    fileUploadSection.style.display = 'none';
                    gitSection.style.display = 'block';
                    // Gitæ¨¡å¼ä¸‹ï¼Œæ ¹æ®æ˜¯å¦æœ‰ä»“åº“åœ°å€å’Œæ ‡é¢˜æ¥å†³å®šæŒ‰é’®çŠ¶æ€
                    createBtn.disabled = !projectTitle.value || !gitUrl.value;
                }
            });
        });

        // ç›‘å¬è¾“å…¥å˜åŒ–
        projectTitle.addEventListener('input', updateCreateButtonState);
        gitUrl.addEventListener('input', updateCreateButtonState);

        function updateCreateButtonState() {
            const sourceType = document.querySelector('input[name="projectSource"]:checked').value;
            if (sourceType === 'files') {
                createBtn.disabled = !projectTitle.value || fileInput.files.length === 0;
            } else {
                createBtn.disabled = !projectTitle.value || !gitUrl.value;
            }
        }

        // ä¿®æ”¹è¡¨å•æäº¤å¤„ç†
        projectForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            const sourceType = document.querySelector('input[name="projectSource"]:checked').value;
            
            if (!projectTitle.value) return;
            if (sourceType === 'files' && fileInput.files.length === 0) return;
            if (sourceType === 'git' && !gitUrl.value) return;

            const projectId = generateProjectId();
            const formData = new FormData();
            
            formData.append('projectId', projectId);
            formData.append('title', projectTitle.value);
            formData.append('description', projectDesc.value);
            formData.append('sourceType', sourceType);

            if (sourceType === 'git') {
                formData.append('gitUrl', gitUrl.value);
                formData.append('gitBranch', gitBranch.value || 'main');
            } else {
                Array.from(fileInput.files).forEach(file => {
                    formData.append('files', file);
                });
            }

            createBtn.disabled = true;
            progressBar.style.width = '0%';
            statusMessage.textContent = sourceType === 'git' ? 'å…‹éš†ä»“åº“ä¸­...' : 'ä¸Šä¼ æ–‡ä»¶ä¸­...';
            statusMessage.className = 'status-message info';

            try {
                const response = await fetch('/api/projects', {
                    method: 'POST',
                    body: formData
                });

                const result = await response.json();

                if (response.ok) {
                    statusMessage.textContent = 'é¡¹ç›®åˆ›å»ºæˆåŠŸï¼';
                    statusMessage.className = 'status-message success';
                    projectForm.reset();
                    selectedFiles.innerHTML = '';
                    fileUploadSection.style.display = 'block';
                    gitSection.style.display = 'none';
                    loadProjects();
                } else {
                    throw new Error(result.error || 'åˆ›å»ºå¤±è´¥');
                }
            } catch (error) {
                statusMessage.textContent = error.message;
                statusMessage.className = 'status-message error';
            } finally {
                createBtn.disabled = false;
            }
        });

        // åŠ è½½é¡¹ç›®åˆ—è¡¨
        async function loadProjects() {
            try {
                const response = await fetch('/api/projects');
                const result = await response.json();
                
                projectsList.innerHTML = result.projects.map(project => `
                    <div class="project-item">
                        <div class="project-info">
                            <div class="project-header">
                                <span class="project-title">${project.title}</span>
                                <span class="project-id">${project.id}</span>
                            </div>
                            ${project.description ? `
                                <div class="project-description">${project.description}</div>
                            ` : ''}
                            <div class="project-meta">
                                ${project.source_type === 'git' ? `
                                    <div class="git-info">
                                        <span class="git-url">ğŸ“¦ ${project.git_url}</span>
                                        <span class="git-branch">ğŸ”– ${project.git_branch}</span>
                                    </div>
                                ` : ''}
                                <div class="project-files">
                                    ${(project.files || []).map(file => `
                                        <span class="file-badge${file.endsWith('.py') ? ' python' : ''}">${file}</span>
                                    `).join('')}
                                </div>
                            </div>
                        </div>
                        <div class="project-actions">
                            <button onclick="deleteProject('${project.id}')" class="btn delete-btn">åˆ é™¤</button>
                        </div>
                    </div>
                `).join('');
            } catch (error) {
                console.error('åŠ è½½é¡¹ç›®åˆ—è¡¨å¤±è´¥:', error);
            }
        }

        // åˆ é™¤é¡¹ç›®
        async function deleteProject(projectId) {
            if (!confirm('ç¡®å®šè¦åˆ é™¤è¿™ä¸ªé¡¹ç›®å—ï¼Ÿ')) return;

            try {
                const response = await fetch(`/api/projects/${projectId}`, {
                    method: 'DELETE'
                });

                if (response.ok) {
                    loadProjects();
                } else {
                    throw new Error('åˆ é™¤å¤±è´¥');
                }
            } catch (error) {
                alert('åˆ é™¤é¡¹ç›®å¤±è´¥: ' + error.message);
            }
        }

        // åˆå§‹åŠ è½½
        loadProjects();
    </script>
</body>
</html> 